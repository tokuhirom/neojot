<html lang="en">
<body>
<div id="doc" contenteditable></div>

<textarea id="result" rows="20" cols="90"></textarea>
<script>
    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, function(match) {
            switch (match) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return match;
            }
        });
    }

    class ModelessMarkdownEditor {
        constructor(docEl) {
            if (!docEl) {
                throw new Error("Missing docEl");
            }
            this.docEl = docEl;

            docEl.addEventListener('paste', (event) => {
                event.preventDefault();

                const text = (event.clipboardData || window.clipboardData).getData('text');
                document.execCommand('insertText', false, text);
            });
            let inserted = false;
            document.addEventListener('input', function(event) {
                if (event.inputType === "insertFromComposition" || event.inputType === "insertCompositionText") {
                    inserted = true;
                }
            });
            docEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (inserted) {
                        inserted = false;
                        return;
                    }
                    e.preventDefault();
                    const newElement = document.createElement('div');
                    newElement.className = "block";
                    newElement.setAttribute("data-src", "");
                    newElement.setAttribute("data-html", "");
                    this.appendChild(newElement);
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.setStart(newElement, 0);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });
        }

        getMarkdown() {
            const result = [];
            this.docEl.querySelectorAll(".block").forEach((el) => {
                const src = el.getAttribute("data-src");
                result.push(src);
            });
            return result.join("\n");
        }
    }

    const editor = new ModelessMarkdownEditor(document.getElementById("doc"));
    setInterval(() => {
        const resultEl = document.getElementById("result");
        resultEl.value = editor.getMarkdown();
    }, 1000);

    function renderLine(src) {
        return src.replace(/\*\*(.+)\*\*|(.)/g, function (_all, bold, raw) {
            if (bold) {
                return `<b>${bold}</b>`;
            } else {
                return raw;
            }
        });
    }

    function renderInline(line) {
        let m = line.match(/^(#{1,6})\s*(.+)/);
        if (m) {
            const klass = 'h' + m[1].length;
            const html = m[2];
            return [klass, html];
        } else {
            const html = renderLine(line);
            return ["raw", html];
        }
    }

    function markdown(src) {
        function createBlock(klass, src, html) {
            return `<div class="block ${klass}" data-src="${escapeHtml(src)}" data-html="${html}">${html}</div>`;
        }

        const lines = src.split(/\n/);
        const results = [];
        while (lines.length > 0) {
            let line = lines.shift();

            const [klass, html] = renderInline(line);
            results.push(createBlock(klass, line, html));
        }
        return results.join("\n");
    }

    function findLineElementInSelection() {
        const selection = window.getSelection();
        if (!selection.rangeCount) return null; // 選択範囲がない場合はnullを返す

        let node = selection.getRangeAt(0).commonAncestorContainer;
        while (node) {
            if (node.classList && node.classList.contains('block')) {
                return node; // '.line' クラスが見つかったら返す
            }
            node = node.parentNode; // 親ノードへ移動
        }
        return null; // '.line' クラスを持つ要素が見つからなかった場合
    }

    function htmlUnescape(str) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = str;
        return textarea.value;
    }

    const docElement = document.getElementById('doc');
    document.addEventListener('selectionchange', function() {
        const activeElement = document.activeElement;
        console.log(activeElement);
        if (docElement.contains(activeElement)) {
            // console.log(`Moved cursor, ${activeElement.innerHTML} ${selection}`);

            const selectedElement = findLineElementInSelection();
            if (selectedElement) {
                // console.log(`selected: ${selectedElement.innerHTML}`);
                docElement.querySelectorAll('.block').forEach(el => {
                    if (el === selectedElement) {
                        if (!selectedElement.hasAttribute("data-enabled-src")) {
                            const src = selectedElement.getAttribute("data-src");
                            selectedElement.innerHTML = src;
                            selectedElement.setAttribute("data-enabled-src", "true");
                        }
                    } else {
                        if (el.hasAttribute("data-enabled-src")) {
                            // blur from editing node...
                            console.log(`SRC: ${el.outerHTML}`)
                            el.setAttribute("data-src", el.innerHTML === "<br>" ? "" : htmlUnescape(el.innerHTML));
                            const [_, html] = renderInline(el.innerHTML);
                            el.setAttribute('data-html', html);
                            el.innerHTML = html;
                            el.removeAttribute("data-enabled-src");
                            console.log(`OUTER: ${el.outerHTML}`)
                        } else {
                            const htmlContent = el.getAttribute('data-html');
                            // console.log(htmlContent);
                            if (htmlContent) {
                                el.innerHTML = htmlContent;
                            }
                        }
                    }
                });
            }
        }
    });

    const doc = document.getElementById("doc");
    doc.innerHTML = markdown("# section\n\n**hoge** sugoizo\nhahaha");
</script>

<style>
    #doc {
        padding: 9px;
    }
    .block {
        min-height: 1em;
    }
    .h1 {
        font-size: 120%;
        font-weight: bold;
    }
    .h2 {
        font-size: 110%;
        font-weight: bold;
    }
    .h3 {
        font-size: 105%;
        font-weight: bold;
    }
    .h4 {
        font-size: 102%;
        font-weight: bold;
    }
</style>
</body>
</html>